<% title "Report - #{h @report.name}" %>

<%= render 'reports/header', :report => @report %>

<div class="tabbed-nav">
  <ul>
    <li><a href="#report_scores_section">Scores</a></li>
    <li><a href="#report_subjects">Subjects</a></li>
    <li><a href="#bill_criteria">Agenda</a></li>
    <%- permitted_to? :edit, @report do -%>
      <li><a href="#visibility">Visibility</a></li>
      <li><a href="#admin">Admin</a></li>
    <%- end -%>
  </ul>

  <div id="report_scores_section" class="section report_scores">
    <h2>Scores</h2>
    <p>We score representatives on how they actually vote.  Votes in favor of <%= link_to "this report's agenda", '#bill_criteria', :'data-tab-select' => 'bill_criteria' %> lead to a high score, votes against, a low one.</p>
    <%- if @report.scores.present? -%>
      <%= render 'politicians/search', :url => user_report_path(@report.user, @report), :replace => 'report_scores' %>
    <%- end -%>
    <%= render 'reports/scores/table', :report => @report, :scores => @scores %>
  </div>

  <div id="report_subjects" class="section last report_subjects">
    <h2>Subjects</h2>
    <p>Subjects for this report are drawn from <%= link_to "the associated bills", '#bill_criteria', :'data-tab-select' => 'bill_criteria' %>.  Follow the links below to find reports on related subjects.</p>
    <%= render 'subjects/cloud', :subjects => @subjects %>
  </div>

  <div id="bill_criteria" class="section">
    <h2>Agenda</h2>
    <p>This reports scores are derived from the bills below.  Votes in favor of supported bills or against opposed bills will lead to higher scores, while votes against these positions will lead to lower scores.</p>
    <ul>
      <%- if @report.bill_criteria.any? {|bc| bc.explanatory_url? }  -%>
      <li>Follow the Evidence links on the right to see the report creator's explanation</li>
      <%- end -%>
      <li>Click on the bill to see its details</li>
    </ul>
    <%- if @report.bill_criteria.present? -%>
      <%- active_bills = @report.bill_criteria.active -%>
      <%- if (supported = active_bills.supported).present? -%>
        <h3>Supported Bills</h3>
        <ul>
          <%- supported.each do |criterion| -%>
            <li class="bill_criterion"><%= render 'bill_criteria/bill_criterion', :bill_criterion => criterion %></li>
          <%- end -%>
        </ul>
      <%- end -%>
      <%- if (opposed = active_bills.opposed).present? -%>
        <h3>Opposed Bills</h3>
        <ul>
          <%- opposed.each do |criterion| -%>
            <li class="bill_criterion"><%= render 'bill_criteria/bill_criterion', :bill_criterion => criterion %></li>
          <%- end -%>
        </ul>
      <%- end -%>
      <%- if (unvoted = @report.bill_criteria.inactive).present? -%>
        <h3>Inactive Bills</h3>
        <p>These bills are supported or opposed by this report, but have not come to a roll call vote.</p>
        <ul>
          <%- unvoted.each do |criterion| -%>
            <li class="bill_criterion"><%= render 'bill_criteria/bill_criterion', :bill_criterion => criterion, :with_support => true %></li>
          <%- end -%>
        </ul>
      <%- end -%>
    <%- elsif @report.user == current_user -%>
      <p>You need to add bills to this report in order to generate a score:</p>
    <%- else -%>
      <p>This report doesn't have any bills selected</p>
    <%- end -%>
  </div>

  <%- permitted_to? :edit, @report do -%>
    <div id="visibility" class="section report_status <%= @report.state %>">
      <h2>Visibility: <%= @report.state.capitalize %></h2>
      <%= content_tag :p, @report.status if @report.status.present? %>
      <%= report_next_steps(@report) %>
    </div>

    <div id="admin" class="section">
      <h2>Admin</h2>
      <ul class="actions_menu">
        <li><%= link_to 'Edit Report', edit_user_report_path(@report.user, @report) %></li>
        <%- permitted_to? :destroy, @report do -%>
        <li><%= raw button_to("Delete Report", [@report.user, @report],
                      :confirm => 'Are you sure you want to delete this report?', :method => :delete) %></li>
        <%- end -%>
      </ul>
    </div>
  <%- end -%>
</div>


